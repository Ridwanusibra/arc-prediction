<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arc Market - Dynamic Predictions</title>
<style>
:root {
  --accent:#00ffd6;
  --bg-dark:#121212;
  --card-dark:#1e1e1e;
  --text-light:#fff;
  --text-muted:#aaa;
  --toast-bg:rgba(0,0,0,0.85);
}

*{box-sizing:border-box;margin:0;padding:0;font-family:sans-serif;}
body{background:var(--bg-dark);color:var(--text-light);min-height:100vh;}

header{
  position:sticky;top:0;backdrop-filter:blur(10px);
  background:rgba(18,18,18,0.9);padding:1rem;
  display:flex;justify-content:space-between;align-items:center;z-index:100;
}
header h1{font-size:1.5rem;}
button{background:var(--accent);border:none;padding:0.5rem 1rem;color:#000;border-radius:0.5rem;cursor:pointer;}
button:disabled{opacity:0.6;cursor:not-allowed;}

.market-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:1rem;padding:1rem;
}
.market-card{
  background:var(--card-dark);padding:1rem;border-radius:1rem;
  transition:transform 0.2s,box-shadow 0.2s;cursor:pointer;
}
.market-card:hover{transform:translateY(-5px);box-shadow:0 4px 20px rgba(0,0,0,0.5);}

.market-header{display:flex;justify-content:space-between;margin-bottom:0.5rem;}
.status-open{color:#0f0;font-weight:bold;}
.status-closed{color:#f00;font-weight:bold;}
.status-resolved{color:#00f;font-weight:bold;}

.probability-bar{background:#333;height:1rem;border-radius:0.5rem;overflow:hidden;margin-top:0.5rem;}
.probability-fill{height:100%;border-radius:0.5rem 0 0 0.5rem;background:linear-gradient(to right,#00ffb0,#00ffd6);}

.toast{
  position:fixed;bottom:1rem;right:1rem;background:var(--toast-bg);
  padding:1rem 1.5rem;border-radius:1rem;display:flex;align-items:center;
  opacity:0;transition:opacity 0.3s;color:#fff;z-index:200;
}
.toast.show{opacity:1;}
.toast span{margin-left:0.5rem;}
.toast.success{border-left:4px solid #0f0;}
.toast.error{border-left:4px solid #f00;}

.modal{
  position:fixed;top:0;left:0;width:100%;height:100%;display:none;
  background:rgba(0,0,0,0.75);justify-content:center;align-items:center;z-index:300;
}
.modal.active{display:flex;}
.modal-content{
  background:var(--card-dark);padding:2rem;border-radius:1rem;max-width:500px;width:90%;
  position:relative;
}
.modal-content h2{margin-bottom:1rem;}
.modal-content .close-btn{position:absolute;top:1rem;right:1rem;cursor:pointer;font-size:1.5rem;}

.bet-tabs{display:flex;gap:1rem;margin:1rem 0;}
.bet-tab{flex:1;text-align:center;padding:0.5rem;border-radius:0.5rem;border:1px solid var(--text-muted);cursor:pointer;}
.bet-tab.active{border-color:var(--accent);background:rgba(0,255,214,0.1);}

.quick-bets{display:flex;gap:0.5rem;margin-bottom:1rem;}
.quick-bets button{flex:1;}

input[type=number]{width:100%;padding:0.5rem;border-radius:0.5rem;border:none;margin-bottom:1rem;}
.focus-visible:focus{outline:2px solid var(--accent);outline-offset:2px;}

.loading{display:flex;flex-direction:column;align-items:center;gap:0.5rem;color:var(--text-muted);}
.loading .spinner{border:4px solid #333;border-top:4px solid var(--accent);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

.countdown{font-size:0.9rem;color:var(--text-muted);}
</style>
</head>
<body>

<header>
  <h1>Arc Market</h1>
  <button id="walletBtn" aria-label="Connect wallet">Connect Wallet</button>
</header>

<div class="market-grid" id="marketsGrid">
  <div class="loading"><div class="spinner"></div>Loading markets...</div>
</div>

<div id="toast" class="toast"><span id="toastIcon"></span><span id="toastMessage"></span></div>

<div class="modal" id="marketModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">×</span>
    <h2 id="modalTitle">Market Title</h2>
    <p id="modalStatus">Status</p>

    <div class="user-bet" id="userPosition" style="display:none;">
      <p>Your bet: <span id="userBetAmount">0</span> USDC</p>
    </div>

    <div class="bet-tabs">
      <div class="bet-tab active" data-side="yes" onclick="selectBetSide('yes')">YES</div>
      <div class="bet-tab" data-side="no" onclick="selectBetSide('no')">NO</div>
    </div>

    <div class="quick-bets">
      <button onclick="setBetAmount(10)">10</button>
      <button onclick="setBetAmount(50)">50</button>
      <button onclick="setBetAmount(100)">100</button>
      <button onclick="setBetAmount(500)">500</button>
    </div>

    <input id="betAmount" type="number" placeholder="Enter amount" min="1">
    <div>
      <p>Fee: <span id="displayFee">0</span> USDC</p>
      <p>Projected Payout: <span id="displayPayout">0</span> USDC</p>
    </div>
    <button id="placeBetBtn" onclick="placeBet()" disabled>Place Bet</button>
  </div>
</div>

<script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
<script>
const CONTRACT_ADDRESS = "0xeCCcF291a8B66e947c6f008D8C2a1A0CE203DAdc";
const USDC_ADDRESS = "0x3600000000000000000000000000000000000000";
const CHAIN_ID = 5042002; // Arc Testnet
const CONTRACT_ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_oracle",
				"type": "address"
			}
		],
		"name": "addOracle",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdraw",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_usdc",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			}
		],
		"name": "SafeERC20FailedOperation",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "better",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "willPriceIncrease",
				"type": "bool"
			}
		],
		"name": "BetPlaced",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "better",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "payout",
				"type": "uint256"
			}
		],
		"name": "BetSettled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "EmergencyWithdrawal",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "endPrediction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "executeWithdrawFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "FeesWithdrawn",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "oracle",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "OraclePriceSubmitted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "bool",
				"name": "willPriceIncrease",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "betAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "minWinPool",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "maxLosePool",
				"type": "uint256"
			}
		],
		"name": "predict",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "time",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "priceIncreased",
				"type": "bool"
			}
		],
		"name": "PredictionEnded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "time",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "PredictionStarted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_oracle",
				"type": "address"
			}
		],
		"name": "removeOracle",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "requestWithdrawFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "settleBets",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_currentPrice",
				"type": "uint256"
			}
		],
		"name": "startPrediction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_price",
				"type": "uint256"
			}
		],
		"name": "submitPrice",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "bets",
		"outputs": [
			{
				"internalType": "address",
				"name": "better",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "willPriceIncrease",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "currentPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "feePercentage",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "fees",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getContractUSDCBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getUserBets",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "better",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "willPriceIncrease",
						"type": "bool"
					}
				],
				"internalType": "struct PredictionMarketFixed.Bet[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isOracle",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "isPredictionEnded",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "isPriceIncreased",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lastPredictionTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "noPool",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "oraclePrices",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "oracles",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "pendingWithdrawalRecipient",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "predictionDuration",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "predictionInterval",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "requiredOracleConfirmations",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "usdc",
		"outputs": [
			{
				"internalType": "contract IERC20",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "userBets",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdrawRequestTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "yesPool",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]; // paste your ABI here

let provider, signer, contract, usdcContract, userAddress;
let currentSide='yes', currentMarket=null;
let countdownIntervals={};

// Toast
function showToast(message,type='success'){
  const toast=document.getElementById('toast');
  toast.className=`toast ${type} show`;
  toast.querySelector('#toastMessage').textContent=message;
  toast.querySelector('#toastIcon').textContent=type==='success'?'✓':'✗';
  setTimeout(()=>{toast.classList.remove('show');},4000);
}

// Wallet
async function connectWallet(){
  if(!window.ethereum){ showToast('Install MetaMask','error'); return; }
  try{
    const accounts=await window.ethereum.request({method:'eth_requestAccounts'});
    userAddress=accounts[0];
    provider=new ethers.providers.Web3Provider(window.ethereum);
    const network=await provider.getNetwork();
    if(network.chainId!==CHAIN_ID){ showToast('Switch to Arc Testnet','error'); return; }
    signer=provider.getSigner();
    contract=new ethers.Contract(CONTRACT_ADDRESS,CONTRACT_ABI,signer);
    usdcContract=new ethers.Contract(USDC_ADDRESS,['function balanceOf(address) view returns(uint256)','function approve(address,uint256) returns(bool)','function allowance(address,address) view returns(uint256)'],signer);
    document.getElementById('walletBtn').textContent=userAddress.slice(0,6)+'...'+userAddress.slice(-4);
    document.getElementById('placeBetBtn').disabled=false;
    showToast('Wallet connected!');
    loadMarkets();
  }catch(e){ console.error(e); showToast('Connection failed','error'); }
}

// Load all active markets
async function loadMarkets(){
  const grid=document.getElementById('marketsGrid');
  grid.innerHTML='<div class="loading"><div class="spinner"></div>Loading markets...</div>';
  try{
    const lastTime = await contract.lastPredictionTime();
    const duration = await contract.predictionDuration();
    const predictionEnded = await contract.isPredictionEnded();
    const yesPool = await contract.yesPool();
    const noPool = await contract.noPool();

    // For now, one active prediction; can extend for multiple by reading events
    const market = {
      id: lastTime.toString(),
      question: "Will price increase?",
      yesPool: yesPool,
      noPool: noPool,
      closeTime: parseInt(lastTime) + parseInt(duration),
      status: predictionEnded ? 'Resolved' : 'Open'
    };

    grid.innerHTML='';
    const total = yesPool.add(noPool);
    const probYes = total.eq(0) ? 50 : yesPool.mul(100).div(total).toNumber();

    const card = document.createElement('div');
    card.className='market-card';
    card.innerHTML=`
      <div class="market-header">
        <span class="market-status status-${market.status.toLowerCase()}">${market.status}</span>
        <span class="countdown" id="countdown-${market.id}">--:--</span>
      </div>
      <p>${market.question}</p>
      <div class="probability-bar"><div class="probability-fill" style="width:${probYes}%"></div></div>
      <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
        <span>${probYes}% YES</span><span>${100-probYes}% NO</span>
      </div>
    `;
    card.onclick=()=>openMarketModal(market);
    grid.appendChild(card);

    startCountdown(market.id, market.closeTime);

  }catch(e){ console.error(e); grid.innerHTML='<p>Error loading markets</p>'; }
}

// Countdown
function startCountdown(id, closeTime){
  const elem=document.getElementById('countdown-'+id);
  if(!elem) return;
  if(countdownIntervals[id]) clearInterval(countdownIntervals[id]);
  countdownIntervals[id]=setInterval(()=>{
    const diff=closeTime-Math.floor(Date.now()/1000);
    if(diff<=0){ elem.textContent='Ended'; clearInterval(countdownIntervals[id]); return; }
    const min=Math.floor(diff/60); const sec=diff%60;
    elem.textContent=`${min}m ${sec}s`;
  },1000);
}

// Modal
function openMarketModal(market){
  currentMarket=market;
  document.getElementById('marketModal').classList.add('active');
  document.getElementById('modalTitle').textContent=market.question;
  document.getElementById('modalStatus').textContent=market.status;
  document.getElementById('userPosition').style.display='none';
}
function closeModal(){ document.getElementById('marketModal').classList.remove('active'); }

// Betting
function selectBetSide(side){
  currentSide=side;
  document.querySelectorAll('.bet-tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`.bet-tab[data-side="${side}"]`).classList.add('active');
}
function setBetAmount(amount){ document.getElementById('betAmount').value=amount; }

async function placeBet(){
  if(!userAddress){ showToast('Connect wallet first','error'); return; }
  const amount=ethers.utils.parseUnits(document.getElementById('betAmount').value||'0',6);
  if(amount.lte(0)){ showToast('Enter valid amount','error'); return; }
  try{
    const allowance=await usdcContract.allowance(userAddress,CONTRACT_ADDRESS);
    if(allowance.lt(amount)){
      await (await usdcContract.approve(CONTRACT_ADDRESS,ethers.constants.MaxUint256)).wait();
      showToast('USDC approved');
    }
    await (await contract.predict(currentSide==='yes', amount, Math.floor(Date.now()/1000)+600,0,ethers.constants.MaxUint256)).wait();
    showToast('Bet placed!');
    closeModal(); loadMarkets();
  }catch(e){ console.error(e); showToast(e.reason||'Transaction failed','error'); }
}

document.getElementById('walletBtn').onclick=connectWallet;
setInterval(()=>loadMarkets(),10000); // live updates every 10s
</script>
</body>
</html>