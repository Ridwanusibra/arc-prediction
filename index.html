<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Arc Prediction</title>
<style>
:root {
  --primary:#4f46e5; --bg:#111827; --card:#1f2937;
  --text:#f9fafb; --error:#ef4444; --success:#10b981;
}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);}
header{display:flex;justify-content:space-between;padding:1rem;background:var(--card);}
button{padding:.5rem 1rem;border:none;border-radius:6px;cursor:pointer;}
button:disabled{opacity:.5;cursor:not-allowed;}
.card{background:var(--card);margin:1rem;padding:1rem;border-radius:8px;}
.toast{position:fixed;top:1rem;right:1rem;padding:.5rem 1rem;border-radius:6px;display:none;color:#fff;}
#toast{background:var(--success);}
#errorToast{background:var(--error);}
input,select{width:100%;margin:.5rem 0;padding:.5rem;border-radius:4px;border:none;}
hr{border:1px solid #374151;margin:1rem 0;}
</style>
</head>
<body>
<header>
  <h2>Arc Prediction Market</h2>
  <div>
    <button id="walletBtn">Connect Wallet</button>
    <button id="disconnectBtn" style="display:none">Disconnect</button>
  </div>
</header>

<div class="card" id="marketCard" style="display:none">
  <h3 id="status"></h3>
  <p>Yes Pool: <span id="yesPool">0</span> USDC</p>
  <p>No Pool: <span id="noPool">0</span> USDC</p>
  <p>Implied Odds — Yes: <span id="yesOdds">0</span>% | No: <span id="noOdds">0</span>%</p>
  <p>Fee: <span id="fee">0</span> USDC</p>
  <p>Closes In: <span id="countdown">--</span></p>

  <select id="direction">
    <option value="true">Price Will Increase</option>
    <option value="false">Price Will Decrease</option>
  </select>

  <input type="number" id="amount" placeholder="Bet amount (USDC)" min="0" />
  <button id="betBtn" disabled>Place Bet</button>

  <hr />
  <h4>Your Bets</h4>
  <div id="userBets">None</div>
</div>

<div class="card" id="adminCard" style="display:none">
  <h3>Oracle / Admin</h3>
  <input type="number" id="oraclePrice" placeholder="Submit price" />
  <button id="submitPriceBtn">Submit Price</button>
  <button id="endBtn">End Prediction</button>
  <button id="settleBtn">Settle Bets</button>
</div>

<div class="toast" id="toast"></div>
<div class="toast" id="errorToast"></div>

<script type="module">
import detectEthereumProvider from 'https://cdn.jsdelivr.net/npm/@metamask/detect-provider/dist/detect-provider.esm.min.js';
import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js';

const CHAIN_ID = 5042002;
const CONTRACT_ADDRESS = '0xeCCcF291a8B66e947c6f008D8C2a1A0CE203DAdc';
const USDC_ADDRESS = '0x3600000000000000000000000000000000000000';
const ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_oracle",
				"type": "address"
			}
		],
		"name": "addOracle",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdraw",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_usdc",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			}
		],
		"name": "SafeERC20FailedOperation",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "better",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "willPriceIncrease",
				"type": "bool"
			}
		],
		"name": "BetPlaced",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "better",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "payout",
				"type": "uint256"
			}
		],
		"name": "BetSettled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "EmergencyWithdrawal",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "endPrediction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "executeWithdrawFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "FeesWithdrawn",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "oracle",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "OraclePriceSubmitted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "bool",
				"name": "willPriceIncrease",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "betAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "minWinPool",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "maxLosePool",
				"type": "uint256"
			}
		],
		"name": "predict",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "time",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "priceIncreased",
				"type": "bool"
			}
		],
		"name": "PredictionEnded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "time",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "PredictionStarted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_oracle",
				"type": "address"
			}
		],
		"name": "removeOracle",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "requestWithdrawFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "settleBets",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_currentPrice",
				"type": "uint256"
			}
		],
		"name": "startPrediction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_price",
				"type": "uint256"
			}
		],
		"name": "submitPrice",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "bets",
		"outputs": [
			{
				"internalType": "address",
				"name": "better",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "willPriceIncrease",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "currentPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "feePercentage",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "fees",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getContractUSDCBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getUserBets",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "better",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "willPriceIncrease",
						"type": "bool"
					}
				],
				"internalType": "struct PredictionMarketFixed.Bet[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isOracle",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "isPredictionEnded",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "isPriceIncreased",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lastPredictionTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "noPool",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "oraclePrices",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "oracles",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "pendingWithdrawalRecipient",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "predictionDuration",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "predictionInterval",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "requiredOracleConfirmations",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "usdc",
		"outputs": [
			{
				"internalType": "contract IERC20",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "userBets",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdrawRequestTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "yesPool",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

let provider, signer, contract, usdc, user, countdownTimer;

// ---- Toast function ----
const toast=(msg,error=false)=>{
  const el=document.getElementById(error?'errorToast':'toast');
  el.textContent=msg; el.style.display='block';
  setTimeout(()=>el.style.display='none',3000);
};

// ---- Wallet ----
async function connect(){
  const eth = await detectEthereumProvider({mustBeMetaMask:true});
  if(!eth) return toast('Install MetaMask', true);
  provider = new ethers.providers.Web3Provider(eth);
  const net = await provider.getNetwork();
  if(net.chainId!==CHAIN_ID) return toast('Switch to Arc Testnet', true);
  [user] = await provider.send('eth_requestAccounts',[]);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  usdc = new ethers.Contract(USDC_ADDRESS, [
    'function balanceOf(address)view returns(uint256)',
    'function allowance(address,address)view returns(uint256)',
    'function approve(address,uint256)'
  ], signer);

  document.getElementById('walletBtn').style.display='none';
  document.getElementById('disconnectBtn').style.display='inline-block';
  document.getElementById('marketCard').style.display='block';

  await load();
  subscribeEvents();
}

function disconnect(){location.reload();}

// ---- Load market & user info ----
async function load(){
  try {
    const [yes,no,end,last,dur,feeBP,owner,isOracle] = await Promise.all([
      contract.yesPool(), contract.noPool(), contract.isPredictionEnded(),
      contract.lastPredictionTime(), contract.predictionDuration(),
      contract.feePercentage(), contract.owner(), contract.isOracle(user)
    ]);

    const yesNum=Number(ethers.utils.formatUnits(yes,6));
    const noNum=Number(ethers.utils.formatUnits(no,6));
    const total=yesNum+noNum || 1;

    document.getElementById('yesPool').textContent=yesNum.toFixed(2);
    document.getElementById('noPool').textContent=noNum.toFixed(2);
    document.getElementById('yesOdds').textContent=((yesNum/total)*100).toFixed(1);
    document.getElementById('noOdds').textContent=((noNum/total)*100).toFixed(1);
    document.getElementById('status').textContent=end?'Market Closed':'Market Open';
    document.getElementById('adminCard').style.display = (user===owner||isOracle)?'block':'none';

    startCountdown(last.add(dur).toNumber());

    const amountEl = document.getElementById('amount');
    amountEl.oninput = async e => {
      const v=Number(e.target.value||0);
      document.getElementById('fee').textContent=((v*feeBP)/10000).toFixed(6);
      document.getElementById('betBtn').disabled = !(v>0 && !end);

      // Potential PnL preview
      const dir=document.getElementById('direction').value==='true';
      const payout = await pnlPreview(dir, ethers.utils.parseUnits(v||'0',6));
      document.getElementById('userBets').innerHTML=`Potential Payout: ${payout} USDC`;
    };

    await loadUserBets();
  } catch(e){ console.error(e); toast('Load failed', true); }
}

async function loadUserBets(){
  const bets = await contract.getUserBets(user);
  const el = document.getElementById('userBets');
  if(!bets.length) return el.textContent='No bets yet';
  el.innerHTML = bets.map(b=>`• ${ethers.utils.formatUnits(b.amount,6)} USDC on ${b.willPriceIncrease?'YES':'NO'}`).join('<br>');
}

// ---- Countdown ----
function startCountdown(end){
  clearInterval(countdownTimer);
  const el = document.getElementById('countdown');
  countdownTimer = setInterval(()=>{
    const d = end - Math.floor(Date.now()/1000);
    if(d<=0){el.textContent='Ended'; clearInterval(countdownTimer); return;}
    el.textContent = `${Math.floor(d/60)}m ${d%60}s`;
  },1000);
}

// ---- Bet ----
async function bet(){
  try{
    const amt=ethers.utils.parseUnits(document.getElementById('amount').value,6);
    const dir=document.getElementById('direction').value==='true';
    const deadline=(await contract.lastPredictionTime()).add(await contract.predictionDuration());
    const allowance=await usdc.allowance(user,CONTRACT_ADDRESS);
    if(allowance.lt(amt)) await (await usdc.approve(CONTRACT_ADDRESS,amt)).wait();
    await (await contract.predict(dir,amt,deadline,0,ethers.constants.MaxUint256)).wait();
    toast('Bet placed'); await load();
  } catch(e){ console.error(e); toast('Bet failed', true); }
}

// ---- PnL Preview ----
async function pnlPreview(dir, amt){
  const yes=await contract.yesPool();
  const no=await contract.noPool();
  const y=Number(ethers.utils.formatUnits(yes,6));
  const n=Number(ethers.utils.formatUnits(no,6));
  const a=Number(ethers.utils.formatUnits(amt,6));
  const total=y+n+a;
  const winPool=dir?y+a:n+a;
  if(winPool===0) return '0';
  const payout=(a/total)*total; // simplified
  return payout.toFixed(6);
}

// ---- Admin ----
async function submitPrice(){ try{ const p=document.getElementById('oraclePrice').value; if(!p) return; await (await contract.submitPrice(p)).wait(); toast('Price submitted'); }catch(e){toast('Submit failed', true);} }
async function endPrediction(){ try{ await (await contract.endPrediction()).wait(); toast('Prediction ended'); await load(); }catch(e){toast('End failed',true);} }
async function settle(){ try{ await (await contract.settleBets()).wait(); toast('Bets settled'); await load(); }catch(e){toast('Settle failed',true);} }

// ---- Event subscriptions ----
function subscribeEvents(){
  contract.on('BetPlaced', load);
  contract.on('PredictionEnded', load);
  contract.on('BetSettled', load);
}

// ---- Button bindings ----
walletBtn.onclick=connect;
disconnectBtn.onclick=disconnect;
betBtn.onclick=bet;
submitPriceBtn.onclick=submitPrice;
endBtn.onclick=endPrediction;
settleBtn.onclick=settle;

// ---- Auto-refresh ----
setInterval(()=>user&&load(),15000);
</script>
</body>
</html>